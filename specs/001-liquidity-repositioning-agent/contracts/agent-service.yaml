# Agent Service API Contract
# Purpose: Automated repositioning orchestration

version: 1.0.0
name: AgentService
description: |
  Orchestrates automated liquidity repositioning workflow. Monitors positions,
  evaluates trigger conditions, and executes multi-step repositioning (unstake -> swap -> mint).

types:
  RepositioningTrigger:
    fields:
      outOfRangeDuration:
        type: duration
        default: 1h
      tickDistanceThreshold:
        type: int32
        default: 10
      minFeeOpportunity:
        type: uint256
        description: Expected fees must exceed gas cost

  RepositioningPlan:
    fields:
      positionID:
        type: uint256
      currentTickLower:
        type: int24
      currentTickUpper:
        type: int24
      newTickLower:
        type: int24
      newTickUpper:
        type: int24
      requiresSwap:
        type: bool
      swapParams:
        type: SwapParams
        nullable: true
      estimatedGasCost:
        type: uint256
      estimatedFeeGain:
        type: uint256

  RepositioningResult:
    fields:
      eventID:
        type: string
      positionID:
        type: uint256
      outcome:
        type: enum[Success, Partial, Failed]
      newPositionID:
        type: uint256
        nullable: true
      transactionHashes:
        type: object
        fields:
          unstake: bytes32
          collect: bytes32
          swap: bytes32
          mint: bytes32
      gasCostTotal:
        type: uint256
      durationSeconds:
        type: uint32

operations:
  StartMonitoring:
    http_method: POST
    path: /agent/start
    description: Start automated position monitoring and repositioning
    request_body:
      type: object
      fields:
        positionIDs:
          type: array[uint256]
        triggers:
          type: RepositioningTrigger
        enabled:
          type: bool
    returns:
      type: object
      fields:
        status:
          type: string
        monitoredCount:
          type: int

  StopMonitoring:
    http_method: POST
    path: /agent/stop
    description: Stop automated monitoring

  EvaluateRepositioning:
    http_method: POST
    path: /agent/evaluate/{positionID}
    description: Check if position should be repositioned
    returns:
      type: object
      fields:
        shouldReposition:
          type: bool
        reason:
          type: string
        plan:
          type: RepositioningPlan
          nullable: true

  ExecuteRepositioning:
    http_method: POST
    path: /agent/reposition/{positionID}
    description: Execute full repositioning workflow
    workflow:
      - step: 1_evaluate
        description: Confirm position still needs repositioning
      - step: 2_generate_plan
        description: Calculate new tick range and swap needs
      - step: 3_unstake
        description: Remove liquidity and collect fees
      - step: 4_swap
        description: Rebalance tokens if needed (conditional)
      - step: 5_mint
        description: Create new position in active range
      - step: 6_verify
        description: Confirm new position is in-range
    returns:
      type: RepositioningResult
    errors:
      - code: POSITION_IN_RANGE
        description: Position no longer needs repositioning
      - code: GAS_TOO_HIGH
        description: Gas price exceeds configured maximum
      - code: FEE_OPPORTUNITY_LOW
        description: Expected fees don't justify gas cost
      - code: PARTIAL_FAILURE
        description: Some steps succeeded, some failed
    performance_target: <2 minutes for full workflow

  GetRepositioningHistory:
    http_method: GET
    path: /agent/history
    parameters:
      - name: positionID
        type: uint256
        in: query
        required: false
      - name: since
        type: timestamp
        in: query
        required: false
      - name: limit
        type: int
        in: query
        default: 50
    returns:
      type: array[RepositioningResult]

validation_rules:
  - rule: gas_cost_check
    description: Don't reposition if gas cost > expected fees
  - rule: price_revalidation
    description: Recheck pool price before each step
  - rule: position_ownership
    description: Only reposition positions owned by configured wallet

error_recovery:
  partial_failure_states:
    unstake_success_swap_failed:
      action: Hold tokens, log error, notify user
    swap_success_mint_failed:
      action: Hold rebalanced tokens, retry mint or notify user
    all_steps_failed:
      action: Position unchanged, log error, continue monitoring

dependencies:
  internal_services:
    - PositionManager
    - LiquidityManager
    - SwapManager
