# Position Manager API Contract
# Purpose: Position monitoring and status querying operations

version: 1.0.0
name: PositionManager
description: |
  Manages querying and monitoring of concentrated liquidity positions on Blackhole DEX.
  Provides functions to retrieve position details, calculate status, and batch query
  multiple positions efficiently.

types:
  Position:
    description: Concentrated liquidity position data
    fields:
      positionID:
        type: uint256
        description: NFT token ID representing the position
        required: true
      owner:
        type: address
        description: Wallet address that owns the position NFT
        required: true
      pool:
        type: address
        description: Address of the Algebra pool contract
        required: true
      token0:
        type: address
        description: Lower-address token in the pair
        required: true
      token1:
        type: address
        description: Higher-address token in the pair
        required: true
      tickLower:
        type: int24
        description: Lower tick bound of position range
        required: true
      tickUpper:
        type: int24
        description: Upper tick bound of position range
        required: true
      liquidity:
        type: uint128
        description: Amount of liquidity in position
        required: true
      amount0:
        type: uint256
        description: Current amount of token0
        required: true
      amount1:
        type: uint256
        description: Current amount of token1
        required: true
      unclaimedFees0:
        type: uint256
        description: Uncollected fees in token0
        required: true
      unclaimedFees1:
        type: uint256
        description: Uncollected fees in token1
        required: true
      status:
        type: PositionStatus
        description: Current position status (InRange, BelowRange, AboveRange)
        required: true
      lastUpdated:
        type: timestamp
        description: When position data was last refreshed
        required: true

  PositionStatus:
    description: Position status enum
    enum:
      - InRange        # tickLower <= currentTick < tickUpper
      - BelowRange     # currentTick < tickLower
      - AboveRange     # currentTick >= tickUpper

  PoolState:
    description: Current state of a concentrated liquidity pool
    fields:
      poolAddress:
        type: address
        description: Address of the pool contract
        required: true
      tick:
        type: int24
        description: Current active tick
        required: true
      sqrtPriceX96:
        type: uint160
        description: Current price in Q64.96 format
        required: true
      activeLiquidity:
        type: uint128
        description: Total liquidity at current tick
        required: true
      lastFee:
        type: uint16
        description: Current swap fee in basis points
        required: true

operations:
  GetPosition:
    description: Query detailed information for a single position
    http_method: GET
    path: /positions/{positionID}
    parameters:
      - name: positionID
        type: uint256
        in: path
        required: true
        description: NFT token ID of the position
      - name: includePoolState
        type: bool
        in: query
        required: false
        default: true
        description: Whether to include current pool state in response
    returns:
      type: Position
      description: Complete position data with current status
    errors:
      - code: POSITION_NOT_FOUND
        description: Position ID does not exist or is not owned by configured wallet
      - code: RPC_ERROR
        description: Failed to query blockchain data
      - code: INVALID_POSITION_ID
        description: Position ID is invalid (must be > 0)
    performance_target: <2 seconds for single position query

  BatchGetPositions:
    description: Query multiple positions in a single RPC batch call
    http_method: POST
    path: /positions/batch
    request_body:
      type: object
      fields:
        positionIDs:
          type: array[uint256]
          required: true
          description: List of position NFT IDs to query
          max_length: 50
    returns:
      type: array[Position]
      description: Array of position data, same order as input IDs
    errors:
      - code: BATCH_TOO_LARGE
        description: Too many positions requested (max 50)
      - code: RPC_ERROR
        description: Failed to execute batch RPC call
      - code: PARTIAL_FAILURE
        description: Some positions failed to load (returns partial results + error list)
    performance_target: <5 seconds for up to 50 positions

  CalculatePositionStatus:
    description: Determine if a position is in-range, below-range, or above-range
    http_method: POST
    path: /positions/{positionID}/status
    parameters:
      - name: positionID
        type: uint256
        in: path
        required: true
    request_body:
      type: object
      fields:
        currentTick:
          type: int24
          required: false
          description: Current pool tick (if not provided, will query from pool)
    returns:
      type: object
      fields:
        status:
          type: PositionStatus
          description: Calculated position status
        tickDistance:
          type: int32
          description: Distance in ticks from nearest range boundary
        timeInRange:
          type: duration
          description: Total time position has been in-range
        timeOutOfRange:
          type: duration
          description: Total time position has been out-of-range
    errors:
      - code: POSITION_NOT_FOUND
        description: Position does not exist
      - code: POOL_QUERY_FAILED
        description: Failed to query pool state
    performance_target: <1 second

  MonitorPositions:
    description: Continuously monitor positions and return status updates
    http_method: WebSocket
    path: /positions/monitor
    request:
      type: object
      fields:
        positionIDs:
          type: array[uint256]
          required: true
          description: List of position IDs to monitor
        pollInterval:
          type: duration
          required: false
          default: 5m
          description: How often to check position status
    response_stream:
      type: PositionStatusUpdate
      fields:
        positionID:
          type: uint256
        oldStatus:
          type: PositionStatus
        newStatus:
          type: PositionStatus
        timestamp:
          type: timestamp
        poolTick:
          type: int24
        tickDistance:
          type: int32
    errors:
      - code: TOO_MANY_POSITIONS
        description: Cannot monitor more than 50 positions simultaneously
      - code: INVALID_POLL_INTERVAL
        description: Poll interval must be between 1m and 1h

  GetPositionMetrics:
    description: Calculate performance metrics for a position
    http_method: GET
    path: /positions/{positionID}/metrics
    parameters:
      - name: positionID
        type: uint256
        in: path
        required: true
      - name: period
        type: string
        in: query
        required: false
        default: "24h"
        description: Time period for metrics (24h, 7d, 30d, all)
    returns:
      type: object
      fields:
        totalFeesEarned0:
          type: uint256
          description: Lifetime fees earned in token0
        totalFeesEarned1:
          type: uint256
          description: Lifetime fees earned in token1
        currentValue:
          type: uint256
          description: Position value in USD
        feeAPR:
          type: float64
          description: Annualized fee return percentage
        timeInRangePercent:
          type: float64
          description: Percentage of time position was in-range
        avgTickDistance:
          type: int32
          description: Average distance from range boundaries
    performance_target: <2 seconds

validation_rules:
  - rule: position_ownership
    description: All queried positions must be owned by configured wallet address
    enforcement: Pre-query validation

  - rule: tick_bounds
    description: Position ticks must be valid (multiples of tick spacing, tickLower < tickUpper)
    enforcement: Post-query validation

  - rule: rate_limiting
    description: Batch queries limited to 50 positions, monitor limited to 50 positions
    enforcement: Request validation

caching_strategy:
  position_data:
    ttl: 60 seconds
    invalidate_on:
      - User transaction affecting position
      - Manual refresh requested

  pool_state:
    ttl: 30 seconds
    invalidate_on:
      - Swap occurs in pool (detected via event logs)
      - Manual refresh requested

dependencies:
  contracts:
    - name: NonfungiblePositionManager
      address: "0x3fED017EC0f5517Cdf2E8a9a4156c64d74252146"
      abi_path: "blackholedex-contracts/artifacts/@cryptoalgebra/integral-periphery/.../INonfungiblePositionManager.json"
      methods:
        - positions(uint256)
    - name: AlgebraPool
      abi_path: "blackholedex-contracts/artifacts/@cryptoalgebra/integral-core/.../IAlgebraPoolState.json"
      methods:
        - safelyGetStateOfAMM()

  rpc:
    provider: Avalanche C-Chain
    methods:
      - eth_call (for contract queries)
      - eth_getLogs (for event monitoring)

performance_requirements:
  batch_rpc_calls: true
  max_concurrent_requests: 10
  timeout_per_request: 10s
  retry_strategy: exponential_backoff(3_attempts, 1s_base)
