# Swap Manager API Contract
# Purpose: Token swap operations for rebalancing

version: 1.0.0
name: SwapManager
description: |
  Manages token swaps via RouterV2 for rebalancing token ratios before minting
  new liquidity positions. Handles token approvals, swap execution, and slippage protection.

types:
  SwapParams:
    fields:
      tokenIn:
        type: address
        required: true
      tokenOut:
        type: address
        required: true
      amountIn:
        type: uint256
        required: true
      amountOutMin:
        type: uint256
        required: true
        description: Minimum output (slippage protection)
      routes:
        type: array[Route]
        required: true
        description: Swap path (can be multi-hop)
      recipient:
        type: address
        required: true
      deadline:
        type: uint256
        required: true

  Route:
    fields:
      pair:
        type: address
        description: Pool address for this hop
      from:
        type: address
        description: Input token
      to:
        type: address
        description: Output token
      stable:
        type: bool
        description: Whether pool uses stable curve
      concentrated:
        type: bool
        description: Whether pool is concentrated liquidity
      receiver:
        type: address
        description: Who receives output tokens

  SwapResult:
    fields:
      amountIn:
        type: uint256
      amountOut:
        type: uint256
      slippageActual:
        type: float64
        description: Actual slippage experienced (%)
      transactionHash:
        type: bytes32
      gasUsed:
        type: uint256

operations:
  ExecuteSwap:
    http_method: POST
    path: /swaps/execute
    request_body:
      type: SwapParams
    workflow:
      - step: 1_validate_params
      - step: 2_check_balance
      - step: 3_approve_router
        description: Approve RouterV2 to spend tokenIn
      - step: 4_call_swap
        description: Call swapExactTokensForTokens
      - step: 5_wait_confirmation
      - step: 6_verify_output
        description: Ensure amountOut >= amountOutMin
    returns:
      type: SwapResult
    errors:
      - code: INSUFFICIENT_BALANCE
      - code: SLIPPAGE_EXCEEDED
      - code: SWAP_FAILED
      - code: APPROVAL_FAILED
    performance_target: <20 seconds

  QuoteSwap:
    http_method: POST
    path: /swaps/quote
    request_body:
      type: object
      fields:
        tokenIn:
          type: address
        tokenOut:
          type: address
        amountIn:
          type: uint256
    returns:
      type: object
      fields:
        expectedOutput:
          type: uint256
        priceImpact:
          type: float64
        routes:
          type: array[Route]
          description: Recommended swap path
    performance_target: <2 seconds

  CalculateSlippage:
    http_method: POST
    path: /swaps/slippage
    request_body:
      type: object
      fields:
        amountIn:
          type: uint256
        expectedOutput:
          type: uint256
        slippagePercent:
          type: float64
    returns:
      type: object
      fields:
        amountOutMin:
          type: uint256
          description: Minimum output accounting for slippage

validation_rules:
  - rule: sufficient_balance
    description: Wallet must have enough tokenIn
  - rule: slippage_reasonable
    description: Slippage must be 0.01% - 10%
  - rule: route_valid
    description: All pools in route must exist

dependencies:
  contracts:
    - name: RouterV2
      address: "0x04E1dee021Cd12bBa022A72806441B43d8212Fec"
      methods:
        - swapExactTokensForTokens
    - name: ERC20Tokens
      methods:
        - approve
        - balanceOf
